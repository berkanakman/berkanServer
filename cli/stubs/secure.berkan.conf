#
# Berkan Secure Site VirtualHost: BERKAN_SITE (HTTPS)
# Managed by Berkan
#

# HTTP -> HTTPS Redirect
<VirtualHost BERKAN_LOOPBACK:BERKAN_HTTP_PORT>
    ServerName BERKAN_SITE.BERKAN_TLD
    RewriteEngine On
    RewriteRule ^(.*)$ https://BERKAN_SITE.BERKAN_TLDBERKAN_HTTPS_SUFFIX$1 [R=301,L]
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost BERKAN_LOOPBACK:BERKAN_HTTPS_PORT>
    ServerName BERKAN_SITE.BERKAN_TLD
    DocumentRoot "BERKAN_SITE_PATH"

    SSLEngine on
    SSLCertificateFile "BERKAN_CERT"
    SSLCertificateKeyFile "BERKAN_KEY"

    # HTTP/2 support
    Protocols h2 http/1.1

    # Alias for Berkan server router (used as fallback)
    Alias /__berkan_router "BERKAN_SERVER_PATH/server.php"

    <Directory "BERKAN_SITE_PATH">
        AllowOverride All
        Require all granted
        Options +FollowSymLinks +MultiViews

        # Site's .htaccess rules run first, then this fallback (InheritDown)
        RewriteEngine On
        RewriteOptions InheritDown
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule .* /__berkan_router [L]
    </Directory>

    <Directory "BERKAN_SERVER_PATH">
        Require all granted
    </Directory>

    # PHP-FPM proxy via Unix socket
    <FilesMatch \.php$>
        SetHandler "proxy:unix:BERKAN_HOME_PATH/BERKAN_PHP_SOCKET|fcgi://localhost"
    </FilesMatch>

    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000"
    Header always set X-Content-Type-Options "nosniff"

    ErrorLog "BERKAN_HOME_PATH/Log/BERKAN_SITE-error.log"
    CustomLog "BERKAN_HOME_PATH/Log/BERKAN_SITE-access.log" common
</VirtualHost>

# Dev server port for HTTPS
<VirtualHost BERKAN_LOOPBACK:60>
    ServerName BERKAN_SITE.BERKAN_TLD
    DocumentRoot "BERKAN_SITE_PATH"

    # Alias for Berkan server router (used as fallback)
    Alias /__berkan_router "BERKAN_SERVER_PATH/server.php"

    <Directory "BERKAN_SITE_PATH">
        AllowOverride All
        Require all granted
        Options +FollowSymLinks +MultiViews

        RewriteEngine On
        RewriteOptions InheritDown
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule .* /__berkan_router [L]
    </Directory>

    <Directory "BERKAN_SERVER_PATH">
        Require all granted
    </Directory>

    # PHP-FPM proxy via Unix socket
    <FilesMatch \.php$>
        SetHandler "proxy:unix:BERKAN_HOME_PATH/BERKAN_PHP_SOCKET|fcgi://localhost"
    </FilesMatch>

    ErrorLog "BERKAN_HOME_PATH/Log/BERKAN_SITE-error.log"
</VirtualHost>
